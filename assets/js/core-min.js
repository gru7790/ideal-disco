const buttonsearch=document.querySelector("#mainbutton");buttonsearch.addEventListener("click",showDataWithImages,!1);const input=document.getElementById("search");input.addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),showDataWithImages())});const base_url="https://getmybest.club/b7de7a5e5e0afeeea2a6d1a728egkm/",container=document.getElementById("container"),counter=document.getElementById("countm"),menu=document.getElementById("nav-wrapper"),el=document.getElementById("up");let lastScrollTop=0,img_src_list=[],checked_tags=[],jsonmap=[],fltr_srcs=[],fltr_ctrs=[],fltr_tags=[];aftsel.addEventListener("change",startfilter,!1),self.addEventListener("load",()=>{startfilter(),getMenu(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/b7de7a5e5e0afeeea2a6d1a728egkm/sw.js").then(e=>{console.log("Service worker successfully registered",e)}).catch(e=>{console.log("Service worker registration failed",e)})});async function getMenu(){let n=document.createElement("ul");menu.appendChild(n);let e=await getNoCacheJSON(base_url+"assets/json/base_data/menu.json");e.forEach(e=>{let t=document.createElement("li");n.appendChild(t),t.insertAdjacentHTML("beforeend",'<a class="td2" target="_blank" href="'+e.url+'">'+e.name+"</a>")})}async function theme_switcher(e,t){let n=document.getElementById(t);document.getElementById(e.id).checked?(n.innerHTML="&#9790;",document.documentElement.setAttribute("data-theme","whitebook"),localStorage.setItem("theme","whitebook")):(n.innerHTML="&#9788;",document.documentElement.setAttribute("data-theme","standard"),localStorage.setItem("theme","standard"))}async function cbx_menu(e,t,n){let a=document.getElementById(t),s=document.getElementById("nav-wrapper");document.getElementById(e.id).checked?(a.innerHTML="&#x2715;",s.setAttribute("class","z_open")):(a.innerHTML=n,s.setAttribute("class","z_close"))}window.addEventListener("scroll",function(){var e=window.pageYOffset||document.documentElement.scrollTop;e>lastScrollTop?el.setAttribute("class","nav-sign up nsw txt_1 button btn_bg z_close"):el.setAttribute("class","nav-sign up nsw txt_1 button btn_bg z_open"),lastScrollTop=e<=0?0:e},!1);async function go_up(){document.body.scrollTop=0,document.documentElement.scrollTop=0}async function startfilter(){var e=new Date(b4sel.value),t=await monthDiff(new Date(aftsel.value),e),n=await getNoCacheJSON(base_url+"assets/json/base_data/filters.json");jsonmap=await getNoCacheJSON(base_url+"assets/json/base_data/jsonmap.json"),fltr_srcs=n.sources,fltr_ctrs=n.countries,fltr_tags=n.tags;let a=[];a.push(await src_Filters("source",fltr_srcs)),a.push(await ctry_Filters("country",fltr_ctrs)),a.push(await fillTagFilters("spectags",fltr_tags)),Promise.all(a);let s=[];s.push(await PreloadLinks(t,e,fltr_ctrs)),s.push(await DailyPreloadLinks(fltr_ctrs)),Promise.all(s)}async function PreloadLinks(t,n,a){let s=[];for(let e=0;e<t+1;e++){let t=new Date;t.setFullYear(n.getFullYear(),n.getMonth()-e);for(let e=0;e<a.length;e++)s.push(await putPreloadLinkToDocument(t,a[e],7))}Promise.all(s)}async function DailyPreloadLinks(n){let a=[],s=new Date;var t=s.getDate();for(let e=1;e<t-1;e++){let t=new Date;t.setFullYear(s.getFullYear(),s.getMonth(),s.getDate()-e);for(let e=0;e<n.length;e++)document.getElementById(n[e]).checked&&a.push(await putPreloadLinkToDocument(t,n[e],10))}Promise.all(a)}async function putPreloadLinkToDocument(e,t,n){t=e.toISOString().substring(0,n)+"-"+t+".json";jsonmap.includes(t)&&(t='<link rel="preload" href="'+base_url+"assets/json/msgs/"+t+'" as="fetch" crossorigin="anonymous">',document.head.insertAdjacentHTML("beforeend",t))}async function getNoCacheJSON(e){let t=await fetch(e,{cache:"no-cache"});return 200==t.status?t.json():(t.status,[])}async function getJSON(e){let t=await fetch(e,{cache:"force-cache"});return 200==t.status?t.json():(t.status,[])}async function src_Filters(e,t){let n=document.getElementById(e);n.innerHTML='<summary class="accordion input1">Выбрать</summary>';let a=[];for(let e=0;e<=t.length-1;e++)a.push(await createCBX(t[e].src_id,t[e].src_name,n));Promise.all(a)}async function ctry_Filters(e,t){let n=document.getElementById(e);n.innerHTML='<summary class="accordion input1">Выбрать</summary>';let a=[];for(let e=0;e<=t.length-1;e++)a.push(await createCBX(t[e],t[e],n));Promise.all(a)}async function fillTagFilters(e,t){checked_tags=[];let n=document.getElementById(e);n.innerHTML='<summary class="accordion input1">Выбрать</summary>';let a=[];for(let e=0;e<=t.length-1;e++)a.push(await createCBX(t[e],t[e],n)),a.push(await getCheckedFltrs(t[e]));Promise.all(a)}async function createCBX(e,t,n){let a="";var s=localStorage.getItem(e);s&&"on"==s&&(a="checked");t='<input id="'+e+'" type="checkbox" onchange="cbx_change(this)" '+a+'><label for="'+e+'">'+t+"</label><br>";n.insertAdjacentHTML("beforeend",t)}async function getCheckedFltrs(e){var t=localStorage.getItem(e);t&&"on"==t&&(checked_tags=checked_tags.concat(e))}async function cbx_change(e){e=e.id;document.getElementById(e).checked?localStorage.setItem(e,"on"):localStorage.setItem(e,"off")}async function monthDiff(e,t){let n;return n=12*(t.getFullYear()-e.getFullYear()),n-=e.getMonth(),n+=t.getMonth(),n<=0?0:n}async function showDataWithImages(){let a=new Date,n=new Date(b4sel.value);var s,t=await monthDiff(new Date(aftsel.value),n);let l=[],r=[];for(let e=0;e<t+1;e++){let t=new Date;t.setFullYear(n.getFullYear(),n.getMonth()-e);for(let e=0;e<fltr_ctrs.length;e++)document.getElementById(fltr_ctrs[e]).checked&&(s=t.toISOString().substring(0,7)+"-"+fltr_ctrs[e]+".json",jsonmap.includes(s)&&l.push(base_url+"assets/json/msgs/"+s))}var c,e=a.getDate();for(let n=0;n<e-1;n++){let t=new Date;t.setFullYear(a.getFullYear(),a.getMonth(),a.getDate()-n);for(let e=0;e<fltr_ctrs.length;e++)document.getElementById(fltr_ctrs[e]).checked&&(c=t.toISOString().substring(0,10)+"-"+fltr_ctrs[e]+".json",jsonmap.includes(c)&&(0==n?r:l).push(base_url+"assets/json/msgs/"+c))}var o=new Date;let i=[];for(let e=0;e<r.length;e++)i.push(await getNoCacheJSON(r[e]));for(let e=0;e<l.length;e++)i.push(await getJSON(l[e]));Promise.all(i).then(e=>{var t=[].concat(...e),e=new Date;showIt(t,a,o,e)})}async function showIt(e,t,n,a){var s=new Date;let r=0;container.innerHTML="";let l=new Date(b4sel.value);var c=l.getTime();let o=new Date(aftsel.value);var i=o.getTime(),d=document.getElementById("sort"),d=d.options[d.selectedIndex].text;let u=e;e=document.getElementById("search").value.toLowerCase().trim().split(" ");sq0=null!=e[0]?e[0]:"",sq1=null!=e[1]?e[1]:"",sq2=null!=e[2]?e[2]:"",sq3=null!=e[3]?e[3]:"",sq4=null!=e[4]?e[4]:"";let m=u.filter(e=>e.msg_original.toLowerCase().includes(sq0)&&e.msg_original.toLowerCase().includes(sq1)&&e.msg_original.toLowerCase().includes(sq2)&&e.msg_original.toLowerCase().includes(sq3)&&e.msg_original.toLowerCase().includes(sq4)&&e.msg_date<=c&&e.msg_date>=i);arrData="Сначала старые"==d?m.sort((e,t)=>e.msg_date-t.msg_date):m.sort((e,t)=>t.msg_date-e.msg_date);let g=[];arrData.forEach(t=>{for(let e=0;e<=t.countries.length-1;e++)document.getElementById(t.countries[e]).checked&&(g=g.concat(t))});let h=[];checked_tags=[];for(let e=0;e<=fltr_tags.length-1;e++)await getCheckedFltrs(fltr_tags[e]);0==checked_tags.length?h=g:g.forEach(t=>{for(let e=0;e<=t.tags.length-1;e++)document.getElementById(t.tags[e]).checked&&(h=h.concat(t))});const f=[...new Set(h.map(e=>JSON.stringify(e)))].map(e=>JSON.parse(e));e=new Date;img_src_list=[];for(let l=0;l<=f.length-1;l++)if(document.getElementById(f[l].src_id).checked){var p=f[l].msg_id;let e=document.createElement("div");e.setAttribute("class","card w05");let a=document.createElement("div");a.setAttribute("class","w1 left");let t=document.createElement("div");t.setAttribute("class","w1 right"),container.appendChild(e),e.appendChild(a),e.appendChild(t);let n=document.createElement("div");n.setAttribute("class","cardheaddiv"),a.appendChild(n);var _=new Date(f[l].msg_date);if(msgdate=new Intl.DateTimeFormat("ru-RU",{dateStyle:"short",timeStyle:"short"}).format(_),n.innerHTML='<p class="caption">'+msgdate+'</p><a class="caption prodname" target="_blank" href="https://t.me/'+f[l].src_username+"/"+p+'">@'+f[l].src_name+"</a>",0<f[l].image.length){let n=document.createElement("div");n.setAttribute("class","row"),a.appendChild(n);for(let t=0;t<=f[l].image.length-1;t++)if(null!==f[l].image[t]){let e=document.createElement("img");4<l&&e.setAttribute("loading","lazy"),f[l].image.length%2!=0&&0==t?e.setAttribute("class","fullimg"):e.setAttribute("class","imggall"),e.src=f[l].image[t],e.setAttribute("onclick","show_this_img(this)"),n.appendChild(e),img_src_list.push(base_url+f[l].image[t])}}if(0<f[l].video.length){let n=document.createElement("div");n.setAttribute("class","row"),a.appendChild(n);for(let t=0;t<=f[l].video.length-1;t++)if(null!==f[l].video[t]){let e=document.createElement("video");e.setAttribute("controls","True"),4<l&&e.setAttribute("preload","none"),f[l].video.length%2!=0&&0==t?e.setAttribute("class","fullimg"):e.setAttribute("class","imggall"),e.src=f[l].video[t],n.appendChild(e)}}if(0<f[l].audio.length){let t=document.createElement("div");t.setAttribute("class","docs"),a.appendChild(t);for(let e=0;e<=f[l].audio.length-1;e++)null!==f[l].audio[e]&&t.insertAdjacentHTML("beforeend",'<audio class="td2" controls preload="none" src="'+f[l].audio[e]+'"></audio>')}if(0<f[l].doc.length){let t=document.createElement("div");t.setAttribute("class","docs"),a.appendChild(t);for(let e=0;e<=f[l].doc.length-1;e++)null!==f[l].doc[e]&&(doc_href=base_url+f[l].doc[e],docn_HTML=f[l].doc[e].split("/").pop(),t.insertAdjacentHTML("beforeend",'<a class="td2" target="_blank" href="'+doc_href+'">'+docn_HTML+"</a>"))}let s=f[l].msg_original;p=s.replaceAll("\n","<br>");t.innerHTML='<p class="comment">'+p+"</p>",r=++r}d=(n-t)/1e3,n=(a-n)/1e3,s=(e-s)/1e3,e=(new Date-e)/1e3,t=(new Date-t)/1e3;return counter.innerHTML="Найдено сообщений: "+r+" за "+t+" сек.<br>Time to create url lists: "+d+"s,<br>Time to make all requests: "+n+"s,<br>Time to sort & filter final array: "+s+"s,<br>Time to create cards: "+e+"s",img_src_list}async function show_this_img(e){const t=document.getElementById("currentIMG");t.src=e.src,t.parentElement.style.display="flex"}function logKey(e){"ArrowRight"==e.code&&nextIMG(),"ArrowLeft"==e.code&&previousIMG(),"Backspace"!=e.code&&"Space"!=e.code||closeIMGviewer()}document.addEventListener("keydown",logKey);async function closeIMGviewer(){const e=document.getElementById("imgcontainer");e.style.display="none"}async function nextIMG(){const e=document.getElementById("currentIMG");var t=e.src,t=img_src_list.indexOf(t);t<img_src_list.length-1?(t=img_src_list[t+1],e.src=t):e.parentElement.style.display="none"}async function previousIMG(){const e=document.getElementById("currentIMG");var t=e.src,t=img_src_list.indexOf(t);0<t?(t=img_src_list[t-1],e.src=t):e.parentElement.style.display="none"}
